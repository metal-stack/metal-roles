events {
}

http {
{% for conf in gardener_shooted_seed.proxy_servers %}
    upstream {{ conf.name }} {
{% for addr in conf.addresses %}
        server {{ addr }};
{% endfor %}
    }

    server {
        listen {{ conf.port }} ssl http2;

        error_log /dev/stdout warn;

        ssl_certificate /etc/ssl/{{ conf.name }}/cert.pem;
        ssl_certificate_key /etc/ssl/{{ conf.name }}/cert.key;
        ssl_client_certificate /etc/ssl/{{ conf.name }}/ca.pem;
        ssl_verify_client on;

        location / {
{% if conf.type == 'grpcs' %}
          grpc_pass grpcs://{{ conf.name }};
{% if conf.type == 'http' %}
          proxy_pass http://{{ conf.name }};
{% endif %}
        }
    }
{% endif %}
}
