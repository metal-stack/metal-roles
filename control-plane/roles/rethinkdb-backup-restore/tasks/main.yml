---
- name: Gather release versions
  setup_yaml:

- name: Check mandatory variables for this role are set
  assert:
    fail_msg: "not all mandatory variables given, check role documentation"
    quiet: yes
    that:
      - rethinkdb_image_name is defined
      - rethinkdb_image_tag is defined
      - rethinkdb_backup_restore_sidecar_image_name is defined
      - rethinkdb_backup_restore_sidecar_image_tag is defined

- name: Check mandatory variables for this role are set
  assert:
    fail_msg: "not all mandatory variables given, check role documentation"
    quiet: yes
    that:
      - rethinkdb_backup_restore_sidecar_image_tag is defined

- name: Migration to separate backup volume (since pre- and post-cmds)
  k8s:
    definition:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: "{{ rethinkdb_name }}"
        namespace: "{{ rethinkdb_namespace }}"
    state: absent
  when: "(lookup('k8s', api_version='apps/v1', kind='StatefulSet', resource_name=rethinkdb_name, namespace=rethinkdb_namespace) | default({}, true)).get('spec', {}).get('volumeClaimTemplates', []) | length == 1"

- name: Deploy rethinkdb (backup-restore)
  k8s:
    definition: "{{ lookup('template', 'rethinkdb.yaml') }}"
    namespace: "{{ rethinkdb_namespace }}"
    apply: yes
