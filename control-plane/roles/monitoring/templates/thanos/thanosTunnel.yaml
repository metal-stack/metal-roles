{% for partition in monitoring_partitions %}
{% for endpoint in partition.thanos_endpoints_shoot %}
---
apiVersion: v1
kind: Secret
metadata:
  name: thanos-tunnel-{{ partition.id  ~ '-' ~ endpoint.name }}-tls
  namespace: monitoring
type: Opaque
data:
  client.key: {{ shoot_prometheus_tls_key }}
  client.crt: {{ shoot_prometheus_tls_cert }}
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZ0VENDQTUyZ0F3SUJBZ0lVQVVDZUZ5aER5Y2Vkd3JoSW1sdzBoVXdFVS9Nd0RRWUpLb1pJaHZjTkFRRU4KQlFBd2FqRUxNQWtHQTFVRUJoTUNSRVV4RURBT0JnTlZCQWdNQjBKaGRtRnlhV0V4RHpBTkJnTlZCQWNNQmsxMQpibWxqYURFT01Bd0dBMVVFQ2d3RlJra3RWRk14RURBT0JnTlZCQXNNQjA5Rk5UVXdOVEF4RmpBVUJnTlZCQU1NCkRWQnliMjFsZEdobGRYTWdRMEV3SGhjTk1qQXdOREUyTVRBMU5UQTNXaGNOTkRnd05ESTVNVEExTlRBM1dqQnEKTVFzd0NRWURWUVFHRXdKRVJURVFNQTRHQTFVRUNBd0hRbUYyWVhKcFlURVBNQTBHQTFVRUJ3d0dUWFZ1YVdObwpNUTR3REFZRFZRUUtEQVZHU1MxVVV6RVFNQTRHQTFVRUN3d0hUMFUxTlRBMU1ERVdNQlFHQTFVRUF3d05VSEp2CmJXVjBhR1YxY3lCRFFUQ0NBaUl3RFFZSktvWklodmNOQVFFQkJRQURnZ0lQQURDQ0Fnb0NnZ0lCQU12NGVuUngKVTNhb3Yxc1h2WTV4cXc0cFM4aUhDYkxyYTRPTGN3ZC9OTndOMnFTbXpsMUhMaGlSd3RqVGExdy9ENkVMdjZnSwpLMXhTdDlPWHUzZ1pIN3J0cXVkS2hDMU9jT0p2VzZUYjN6LzdoZWdySm5MNm5IVFFtL0NPSzJaTDFvdWhvREZmCmFNTUQyQjd0MFJEL3RVWElTSkVnVW9rSXE1Q0o2SktsR2J3K3NjZ29rYWNjVVRIbDh3Zi95SExXT3NUZDZYbnAKa2pTWEVlZStUZUMyYnhOa3o5TGVQREVLSkhmZ1BNZytGT1cyOXkvVkdkSmw2OVRGc2I4MFE0V292TGg5aTA2SQpuMm9QdWlMUVRVeCsvbGtOY0k0YTIzN09XdmhPWHRlTG4xbGF0NThNMklySGhZait4T2NESklmNGgrUThoRnBECmxEK1EyVmJkQ3dOUVIyd3RMYTFvTE03TkJ2WDhxUDV6N3R2TW1rTHdUdWtnT2JJQlYrWm5VN0hGaFBtRUYwYXQKVkZrRXZ0b2lLVjFLbGRhWmZITWs5RERUMFh5SWpwS0JZWXB0dmxkZUhMKytORk8vWlNxV2U2aURjclluWjh3MQoweTFVUWZWSXJUWDhacjEvTHNRWHZnQU1nUGxURzFzeE1zMGZnVU5MVHljM0x6cEh4aGxFZmk3NXBHZS9iRm5ZCkp4aXJUVUxaYmZCcWZqWnNYT0RDOTN1KzBER28xU00xckZBVWMwaDBXYWh3S1k0YlRKTnA2Ym5jRENaZHpHUm4KZDhhY0FZYVRyUjRGR1JRUThWMEhXOFhMdkpoejNKS3R1elR4enVUQi9NUXd2ckdIVEI1YXpQbnR2K0MzeEkzawpLTHFHNnl2WTBGdVN4OUJWUFVmcFFqSHUwNERsamd6aXNTOWpBZ01CQUFHalV6QlJNQjBHQTFVZERnUVdCQlFEClQyN0NBRTVxQ2U2Y01xeVhmV0VsVlRrcFREQWZCZ05WSFNNRUdEQVdnQlFEVDI3Q0FFNXFDZTZjTXF5WGZXRWwKVlRrcFREQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01BMEdDU3FHU0liM0RRRUJEUVVBQTRJQ0FRQ3ZmUG83MlcyawozMVFPd1Z5dThZUDBMVnRPRHN4WnpNcFZwWm8rRFhMdUtkVU5ZckQwRnI4NFF2Y0RDT2xTNG5BanMybmpjbTI1Cmk0Tzh4VkpJUXBkaDZhZHNqeHhnVTdETENHK1ZyOUdCQ1pkbmJWRTBHbVRMbnRQTWdUVjBQRnF0T2owd0ROQTQKbittSVNxbXVNaXRZdlBuNnlVRkVDTmF0Y2dEMTBIM216UWZzNjlmOW5iY2ZCKzhheHdKUVVXR0NzaGZtSEhiZApWd0M0TmU1WnVITnRPNC9FcHl3VE5mc3lKNW1ldlFybDhmUVdCc0ZnaTZBYnBTK201cjN1NHczMGd1eXZoVzBpCjR5K05MWVdVUlZSNXQzUnlXa3MvSzlDcFljcHdvODdRRFgzdDhsaVFMcDhsNHJLTDk0ZEF2NkVXVS9pN3JOVnQKdkZGMWduMjlzYXhIbFZUZTkrdG9vdVNQbVRWSitPNDJRQjcwN1NVNHpaT1c2VVN4OVNIUHBFeWl5Tk8xdDZvUQpvNnJSYzRZR0RhWGtOZDhVTGszcEovQ2d3bkppemZGYVcwTUw3OGRueW9LZzFTR0FpRDlPaE1KcFlqcTNURkxJCkR2ZEh2ODFJYS9nWmhUR0VHZWhHbFNYc1pxdVBudXVkVzlOZVhra3JqWDdiRHNQbzVsdnNSdEx3VDJuNzJPWkEKWXVtT01jeHNDQ3ZJRDEyYW5HWXJ4eHpsWSs1UWRGTE5hQnZoeXNKY0MzbTMvaWF4cDh6WHhFeFJNSzhveUMrOQovN01LZFVPTXRSa1dLeHpUcXYwVjZBZGRDdzhFTXFmbGdVVUZjVDJLa0dUVGJNby90TVVtNDJNbTUvZEFSNWp3CmphOU1CaFZQNXk5REdqY0UxTlBjNXBJQit1cWE5Z0hIVEE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: thanos-tunnel-{{ partition.id  ~ '-' ~ endpoint.name }}
spec:
  selector:
    matchLabels:
      app: thanos-tunnel-{{ partition.id  ~ '-' ~ endpoint.name }}
  replicas: 1
  template:
    metadata:
      labels:
        app: thanos-tunnel-{{ partition.id  ~ '-' ~ endpoint.name }}
    spec:
      containers:
      - name: tls-proxy
        image: squareup/ghostunnel:v1.5.2
        args:
        - client
        - --listen=:10901
        - --unsafe-listen
        - --key=/cert/client.key
        - --cert=/cert/client.crt
        - --cacert=/cert/ca.crt
        - --target={{ endpoint.url }}:10901
        ports:
        - containerPort: 10901
          name: grpc
          protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
        volumeMounts:
        - mountPath: /cert
          name: cert
          readOnly: true
      volumes:
      - name: cert
        secret:
          secretName: thanos-tunnel-{{ partition.id  ~ '-' ~ endpoint.name }}-tls
---
apiVersion: v1
kind: Service
metadata:
  name: thanos-tunnel-{{ partition.id  ~ '-' ~ endpoint.name }}
  labels:
    app: thanos-tunnel-{{ partition.id  ~ '-' ~ endpoint.name }}
spec:
  ports:
  - name: grpc
    port: 10901
    protocol: TCP
    targetPort: 10901
  selector:
    app: thanos-tunnel-{{ partition.id  ~ '-' ~ endpoint.name }}

{% endfor %}
{% endfor %}
