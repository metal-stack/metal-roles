---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gardener-blackbox-exporter
  labels:
    app: gardener
    role: gardener-blackbox-exporter
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gardener.cloud:metrics-exporter
rules:
- apiGroups:
  - core.gardener.cloud
  resources:
  - shoots
  - projects
  - seeds
  - plants
  verbs:
  - get
  - watch
  - list
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: gardener.cloud:blackbox-exporter
subjects:
- kind: ServiceAccount
  name: gardener-blackbox-exporter
  namespace: {{ monitoring_namespace }}
roleRef:
  kind: ClusterRole
  name: gardener.cloud:blackbox-exporter
  apiGroup: rbac.authorization.k8s.io
apiVersion: v1
kind: Secret
metadata:
  name: seed-kubecfg
data:
  kubecfg.yaml: {{ monitoring_gardener_virtual_garden_kubeconfig }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: blackbox-exporter-config
  namespace: {{ monitoring_namespace }}
  labels:
    k8s-app: gardener-blackbox-exporter
data:
  blackbox.yaml: |
    modules:
      http_2xx:
        http:
          no_follow_redirects: true
          preferred_ip_protocol: ip4
          valid_http_versions:
          - HTTP/1.1
          - HTTP/2.0
          valid_status_codes: []
        prober: http
        timeout: 5s
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gardener-blackbox-exporter
  labels:
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gardener
      role: gardener-blackbox-exporter
  template:
    metadata:
      labels:
        app: gardener
        role: gardener-blackbox-exporter
    spec:
      serviceAccountName: gardener-blackbox-exporter
      automountServiceAccountToken: false
      containers:
      - name: gardener-blackbox-exporter
        image: {{ monitoring_gardener_blackbox_exporter_image_name }}:{{ monitoring_gardener_blackbox_exporter_image_tag }}
        imagePullPolicy: {{ metal_control_plane_image_pull_policy }}
        command:
        - /gardener-blackbox-exporter
        - --bind-address=0.0.0.0
        - --port=9115
        - --kubeconfig=/etc/seed/kubecfg.yaml
        ports:
        - name: metrics
          containerPort: 9115
        volumeMounts:
          - mountPath: /etc/seed
            name: seed-kubecfg
            readOnly: true
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
      volumes:
        - name: seed-kubecfg
          secret:
            defaultMode: 420
            secretName: seed-kubecfg
---
apiVersion: v1
kind: Service
metadata:
  name: gardener-blackbox-exporter
  labels:
    app: gardener-blackbox-exporter
spec:
  type: ClusterIP
  sessionAffinity: None
  selector:
    app: gardener
    role: gardener-blackbox-exporter
  ports:
  - protocol: TCP
    port: 9115
    targetPort: 9115
