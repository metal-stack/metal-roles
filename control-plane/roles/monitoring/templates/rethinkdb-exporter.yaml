---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rethinkdb-exporter
  namespace: monitoring
  labels:
    app: rethinkdb-exporter
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rethinkdb-exporter
  namespace: monitoring
  labels:
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rethinkdb-exporter
  template:
    metadata:
      labels:
        app: rethinkdb-exporter
    spec:
      serviceAccountName: rethinkdb-exporter
      containers:
      - name: rethinkdb-exporter
        image: mwennrich/rethinkdb-exporter:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: DB_PASSWORD
          value: {{ metal_db_password }}
        - name: DB_ADDRESSES
          value: metal-db.metal-control-plane:28015
        - name: STATS_TABLE_ESTIMATES
          value: "true"
        ports:
        - name: metrics
          containerPort: 9055
---
apiVersion: v1
kind: Service
metadata:
  name: rethinkdb-exporter
  namespace: monitoring
  labels:
    app: rethinkdb-exporter
spec:
  type: ClusterIP
  sessionAffinity: None
  selector:
    app: rethinkdb-exporter
  ports:
  - name: metrics
    protocol: TCP
    port: 9055
    targetPort: 9055
