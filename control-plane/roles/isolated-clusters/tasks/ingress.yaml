- name: Get kubeconfig
  copy:
    src: "files/kubeconfigs/kubeconfig.{{ cluster }}"
    dest: "/tmp/kubeconfig.{{ cluster }}"

- name: Create namespace for ingress-controller
  k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ isolated_clusters_ingress_controller_namespace }}"
        labels:
          app.kubernetes.io/part-of: "{{ isolated_clusters_group_label }}"
    apply: yes
    kubeconfig: {{ isolated_clusters_virtual_garden_kubeconfig | shoot_admin_kubeconfig(shoot.project_namespace, shoot_name) }}

- name: Add ingress nginx repository
  kubernetes.core.helm_repository:
    repo_url: ""
    repo_name: "ingress-nginx"
    kubeconfig: {{ isolated_clusters_virtual_garden_kubeconfig | shoot_admin_kubeconfig(shoot.project_namespace, shoot_name) }}

- name: Deploy ingress nginx controller
  kubernetes.core.helm:
    name: ingress-nginx
    chart_ref: https://kubernetes.github.io/ingress-nginx
    chart_version: "{{ isolated_clusters_ingress_controller_chart_version }}"
    namespace: "{{ isolated_clusters_ingress_controller_namespace }}"
    values_files:
      - ingress/values.yaml
    kubeconfig: {{ isolated_clusters_virtual_garden_kubeconfig | shoot_admin_kubeconfig(shoot.project_namespace, shoot_name) }}
