- name: Get kubeconfig
  copy:
    src: "files/kubeconfigs/kubeconfig.{{ cluster }}"
    dest: "/tmp/kubeconfig.{{ cluster }}"

- name: Create namespace for ingress-controller
  k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ isolated_clusters_ingress_controller_namespace }}"
        labels:
          app.kubernetes.io/part-of: "{{ isolated_clusters_group_label }}"
    apply: yes
  environment:
    K8S_AUTH_KUBECONFIG: "/tmp/kubeconfig.{{ cluster }}"

- name: Deploy ingress-controller
  include_role:
    name: ansible-common/roles/helm-chart
    apply:
      environment:
        KUBECONFIG: "/tmp/kubeconfig.{{ cluster }}"
  vars:
    helm_repo: https://kubernetes.github.io/ingress-nginx
    helm_chart_version: "{{ isolated_clusters_ingress_controller_chart_version }}"
    helm_chart: ingress-nginx
    helm_release_name: ingress-nginx
    helm_target_namespace: "{{ isolated_clusters_ingress_controller_namespace }}"
    helm_value_file_template: ingress/values.yaml
