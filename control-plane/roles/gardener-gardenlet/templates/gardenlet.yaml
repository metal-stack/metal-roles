---
apiVersion: seedmanagement.gardener.cloud/v1alpha1
kind: Gardenlet
metadata:
  name: "{{ _config.name }}"
  namespace: garden
spec:
  deployment:
    replicaCount: 2
    revisionHistoryLimit: 2
    podLabels:
      networking.resources.gardener.cloud/to-virtual-garden-kube-apiserver-tcp-443: allowed
    helm:
      ociRepository:
        ref: "{{ gardener_gardenlet_helm_chart }}"
{% if _config.image_vector_overwrite %}
    imageVectorOverwrite: |
      images:
        {{ gardener_image_vector_overwrite | to_yaml | indent(width=10, first=false) }}
{% endif %}
{% if _config.component_image_vector_overwrite %}
    componentImageVectorOverwrites: |
        {{ _config.component_image_vector_overwrite | to_yaml | indent(width=10, first=false) }}
{% endif %}
    image:
      repository: {{ gardener_gardenlet_image_name }}
      tag: {{ gardener_gardenlet_image_tag }}
      pullPolicy: {{ metal_control_plane_image_pull_policy }}
  config:
    apiVersion: gardenlet.config.gardener.cloud/v1alpha1
    kind: GardenletConfiguration
    controllers:
      shoot:
        concurrentSyncs: {{ _config.shoot_concurrent_syncs }}
        reconcileInMaintenanceOnly: {{ _config.shoot_reconcile_in_maintenance_only | lower }}
        # allow setting shoot ignore annotation:
        respectSyncPeriodOverwrite: {{ _config.shoot_respect_sync_period_overwrite | lower }}
      shootState:
        concurrentSyncs: 0
      backupEntry:
        deletionGracePeriodHours: {{ _config.backup_entry_deletion_grace_period_hours }}
        deletionGracePeriodShootPurposes:
        - evaluation
        - infrastructure
        - production
    logging:
      enabled: {{ _config.logging_enabled | lower }}
      vali:
        enabled: {{ _config.logging_vali_enabled | lower }}
      shootNodeLogging:
        shootPurposes:
        - infrastructure
        - production
        - development
        - evaluation
    seedConfig:
      apiVersion: core.gardener.cloud/v1beta1
      kind: Seed
      metadata:
        labels:
          name: "{{ _config.name }}"
      spec:
        backup: {{ _config.backup_infrastructure | to_json }}
        dns:
          provider:
            secretRef:
              name: "{{ lookup('k8s', kubeconfig=virtual_garden_kubeconfig, api_version='v1', kind='Secret', namespace='garden', label_selector='gardener.cloud/role=internal-domain').get('metadata', {}).get('name') }}"
              namespace: garden
            type: "{{ gardener_gardenlet_default_dns_provider }}"
        ingress:
          controller:
            kind: nginx
          domain: "{{ gardener_gardenlet_default_dns_domain }}"
{% if _is_local %}
        networks:
          nodes: "{{ _gardener_gardenlet_node_cidr }}"
          pods: "{{ _gardener_gardenlet_pod_cidr }}"
          services: "{{ _gardener_gardenlet_service_cidr }}"
{% endif %}
        provider:
          region: local
          type: "{{ metal_control_plane_host_provider }}"
        settings:
          excessCapacityReservation:
            enabled: false
          scheduling:
            visible: false
          shootDNS:
            enabled: true
          verticalPodAutoscaler:
            enabled: {{ _config.vertical_pod_autoscaler_enabled | lower }}
