---
- name: Get kubeconfig for virtual garden access
  virtual_garden_kubeconfig:
    garden_name: "{{ gardener_gardenlet_garden_name }}"

- name: Deploy domain secrets (in virtual apiserver)
  k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        namespace: garden
        annotations:
          helm.sh/resource-policy: keep
          dns.gardener.cloud/domain: "{{ gardener_gardenlet_dns_domain }}"
          dns.gardener.cloud/provider: "{{ gardener_gardenlet_dns_provider }}"
        labels:
          app: gardener
          gardener.cloud/role: "{{ item }}"
        name: "{{ item }}-{{ gardener_gardenlet_dns_domain | regex_replace('\\.', '-') }}"
      type: Opaque
      data: "{{ gardener_gardenlet_dns_credentials }}"
    kubeconfig: "{{ virtual_garden_kubeconfig }}"
    apply: true
  loop:
    - internal-domain
    - default-domain

- name: Deploy Local Gardenlet
  import_tasks: gardenlet_local.yaml
  when: gardener_gardenlet_deploy_local
