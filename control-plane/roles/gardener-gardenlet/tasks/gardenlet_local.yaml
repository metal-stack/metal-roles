---
- name: Set cidrs from garden
  set_fact:
    _gardener_gardenlet_node_cidr: "{{ lookup('k8s', api_version='operator.gardener.cloud/v1alpha1', kind='Garden', resource_name=gardener_gardenlet_garden_name).spec.runtimeCluster.networking.nodes[0] }}"
    _gardener_gardenlet_pod_cidr: "{{ lookup('k8s', api_version='operator.gardener.cloud/v1alpha1', kind='Garden', resource_name=gardener_gardenlet_garden_name).spec.runtimeCluster.networking.pods[0] }}"
    _gardener_gardenlet_service_cidr: "{{ lookup('k8s', api_version='operator.gardener.cloud/v1alpha1', kind='Garden', resource_name=gardener_gardenlet_garden_name).spec.runtimeCluster.networking.services[0] }}"

- name: Create backup infrastructure secret
  k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: backup-secret
        namespace: garden
      type: Opaque
      data: "{{ gardener_gardenlet_local.backup_infrastructure_secret }}"
    kubeconfig: "{{ virtual_garden_kubeconfig }}"
    apply: yes
  when: gardener_gardenlet_local.backup_infrastructure_secret

- name: Deploy Local Gardenlet
  k8s:
    kubeconfig: "{{ virtual_garden_kubeconfig }}"
    apply: true
    definition: "{{ lookup('template', 'gardenlet.yaml') }}"
  vars:
    _is_local: true
    _config: "{{ gardener_gardenlet_defaults | ansible.builtin.combine(gardener_gardenlet_local_defaults, recursive=true) | ansible.builtin.combine(gardener_gardenlet_local, recursive=true) }}"
