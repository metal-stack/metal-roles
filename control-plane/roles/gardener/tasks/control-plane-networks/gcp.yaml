---
# GKE sometimes changes the cidrs, which is a validation error for Gardener.
# Therefore, do not touch the cidrs once deployed
- name: Describe GCP cluster
  command: gcloud --format json container clusters describe {{ gcp_cluster_name }} --zone {{ gcp_location }}
  register: gcp_cluster
  changed_when: false

- name: Describe GCP container subnets
  command: gcloud --format json container subnets list-usable
  register: gcp_subnets
  changed_when: false

- name: Set node cidr
  set_fact:
    _gardener_soil_node_cidr: "{{ (gcp_subnets.stdout | from_json) | extract_gcp_node_network(region=gcp_region) }}"

- name: Set pod cidr
  set_fact:
    _gardener_soil_pod_cidr: "{{ lookup('k8s', kind='Node')[0].get('spec', {}).get('podCIDR') }}"

- name: Set service cidr
  set_fact:
    _gardener_soil_service_cidr: "{{ (gcp_cluster.stdout | from_json)['servicesIpv4Cidr'] }}"
