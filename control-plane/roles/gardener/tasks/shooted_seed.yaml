---
- name: Acquire shooted seed static ips
  metal_ip:
    ip: "{{ item }}"
    name: "{{ gardener_shooted_seed.name }}"
    description: "Seed metallb ip"
    network: "{{ gardener_shooted_seed.internet_network_id }}"
    project: "{{ gardener_shooted_seed.project_id }}"
    api_hmac: "{{ metal_api_admin_key }}"
    api_url: "{{ metal_api_url }}"
  loop: "{{ gardener_shooted_seed.ips }}"

- name: Create backup infrastructure secret for shooted seed
  k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ gardener_shooted_seed.name }}-backup-secret"
        namespace: garden
      type: Opaque
      data: "{{ gardener_backup_infrastructure_secret }}"
    kubeconfig: "{{ gardener_kube_apiserver_kubeconfig_path }}"
    apply: yes

- name: Create backup infrastructure config for shooted seed
  set_fact:
    gardener_shooted_seed_backup_infratructure:
      provider: "{{ gardener_backup_infrastructure.provider }}"
      region: "{{ gardener_backup_infrastructure.region }}"
      secretRef:
        name: "{{ gardener_shooted_seed.name }}-backup-secret"
        namespace: garden

- name: Add seed provider secret
  k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ gardener_shooted_seed.name }}-provider-secret"
        namespace: garden
        labels:
          cloudprofile.garden.sapcloud.io/name: metal
      type: Opaque
      data:
        metalAPIHMac: "{{ gardener_shooted_seed.metal_api_hmac | b64encode }}"
    kubeconfig: "{{ gardener_kube_apiserver_kubeconfig_path }}"
    apply: yes

- name: Add secret binding
  k8s:
    definition:
      apiVersion: core.gardener.cloud/v1alpha1
      kind: SecretBinding
      metadata:
        labels:
          cloudprofile.garden.sapcloud.io/name: metal
        name: "{{ gardener_shooted_seed.name }}-provider-secret"
        namespace: garden
      secretRef:
        name: "{{ gardener_shooted_seed.name }}-provider-secret"
        namespace: garden
    kubeconfig: "{{ gardener_kube_apiserver_kubeconfig_path }}"
    apply: yes

- name: Deploy shooted seed
  k8s:
    definition: "{{ lookup('template', 'shooted-seed.j2') }}"
    kubeconfig: "{{ gardener_kube_apiserver_kubeconfig_path }}"
    apply: yes

- name: Deploy managed seed resource
  k8s:
    definition: "{{ lookup('template', 'managed-seed.j2') }}"
    kubeconfig: "{{ gardener_kube_apiserver_kubeconfig_path }}"
    apply: yes

# can be useful for rollouts where the shooted seed or managed seed resource changes:
# - name: Wait before continuing
#   ansible.builtin.pause:
#     minutes: 5
