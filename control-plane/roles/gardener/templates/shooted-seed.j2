apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: "{{ gardener_shooted_seed.name }}"
  namespace: garden
  annotations:
      garden.sapcloud.io/createdBy: cp@metal-pod.io
      shoot.gardener.cloud/managed-seed-api-server: "{{ true | managed_seed_annotation(api_server=gardener_shooted_seed.api_server) }}"
      cluster.metal-stack.io/name: "{{ gardener_shooted_seed.name }}"
      cluster.metal-stack.io/project: "{{ gardener_shooted_seed.project_id }}"
      cluster.metal-stack.io/tenant: "{{ metal_control_plane_provider_tenant }}"
spec:
  seedName: "{{ gardener_seed.name }}"
  secretBindingName: "{{ gardener_shooted_seed.name }}-provider-secret"
  cloudProfileName: metal
  region: "{{ gardener_shooted_seed.region }}"
  purpose: infrastructure
  tolerations:
    - key: seed.gardener.cloud/protected
    - key: seed.gardener.cloud/invisible
    - key: seed.gardener.cloud/disable-capacity-reservation
  addons:
    kubernetes-dashboard:
      enabled: false
    nginx-ingress:
      enabled: false
  kubernetes:
    version: "{{ gardener_shooted_seed.k8s_version }}"
    kubelet:
      maxPods: {{ gardener_shooted_seed_max_pods }}
    kubeControllerManager:
      nodeCIDRMaskSize: {{ gardener_shooted_seed_node_cidr_mask_size }}
  provider:
    type: metal
    workers:
{% if gardener_shooted_seed.worker_count > 0 %}
    - name: default-worker
      maximum: {{ gardener_shooted_seed.worker_count }}
      minimum: {{ gardener_shooted_seed.worker_count }}
      maxSurge: {{ gardener_shooted_seed.worker_count }}
      maxUnavailable: 0
      machine:
        type: "{{ gardener_shooted_seed.worker_size }}"
        image: {{ gardener_shooted_seed.worker_image | to_json }}
{% endif %}
{% for worker_group in gardener_shooted_seed.additional_worker_groups | default([]) %}
    - name: "group-{{ loop.index0 }}"
      maximum: {{ worker_group.worker_count }}
      minimum: {{ worker_group.worker_count }}
      maxSurge: 3
      maxUnavailable: 0
      machine:
        type: "{{ worker_group.worker_size }}"
        image: {{ worker_group.worker_image | to_json }}
{% endfor %}
{% for worker_group in gardener_shooted_seed.additional_cri_worker_groups | default([]) %}
    - name: "group-cri-{{ loop.index0 }}"
      cri:
        name: {{ worker_group.worker_cri }}
      maximum: {{ worker_group.worker_count }}
      minimum: {{ worker_group.worker_count }}
      maxSurge: {{ worker_group.worker_max_surge }}
      maxUnavailable: {{ worker_group.worker_max_unavailable }}
      machine:
        type: "{{ worker_group.worker_size }}"
        image: {{ worker_group.worker_image | to_json }}
{% endfor %}
    infrastructureConfig:
      apiVersion: metal.provider.extensions.gardener.cloud/v1alpha1
      kind: InfrastructureConfig
      firewall:
        image: "{{ gardener_shooted_seed.firewall_image }}"
        size: "{{ gardener_shooted_seed.firewall_size }}"
        networks: {{ gardener_shooted_seed.networks | to_json }}
      projectID: "{{ gardener_shooted_seed.project_id }}"
      partitionID: "{{ gardener_shooted_seed.partition }}"
    controlPlaneConfig:
      apiVersion: metal.provider.extensions.gardener.cloud/v1alpha1
      kind: ControlPlaneConfig
{% if 'storage_class_name' in gardener_shooted_seed %}
      customDefaultStorageClass:
        className: {{ gardener_shooted_seed.storage_class_name }}
{% endif %}
      iamconfig:
        issuerConfig:
          url: "{{ gardener_shooted_seed.dex_address }}"
          clientId: "{{ gardener_shooted_seed.client_id }}"
        idmConfig:
          idmtype: "{{ gardener_shooted_seed.provider_tenant_directory_type }}"
        groupConfig:
          namespaceMaxLength: 20
      featureGates: {{ gardener_shooted_seed.feature_gates | to_json }}
  networking:
    type: calico
    pods: 10.244.128.0/18
    services: 10.244.192.0/18
    providerConfig:
      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
      kind: NetworkConfig
      backend: none
      ipv4:
        mode: Never
      typha:
        enabled: false
  maintenance:
    timeWindow:
      begin: 220000+0100
      end: 230000+0100
    autoUpdate:
      kubernetesVersion: false
      machineImageVersion: false
