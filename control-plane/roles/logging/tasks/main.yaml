---
- name: Gather release versions
  setup_yaml:

- name: Create namespace {{ logging_namespace }}
  k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ logging_namespace }}"
        labels:
          name: "{{ logging_namespace }}"

- name: Deploy basic auth secret for loki
  k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: loki-basic-auth
      type: Opaque
      data:
        auth: "{{ logging_ingress_loki_basic_auth | b64encode }}"
    namespace: "{{ logging_namespace }}"
    apply: true
  when: logging_ingress_loki_basic_auth

- name: Deploy loki
  include_role:
    name: ansible-common/roles/helm-chart
  vars:
    helm_repo: "{{ logging_chart_repo }}"
    helm_chart: loki
    helm_target_namespace: "{{ logging_namespace }}"
    helm_release_name: loki
    helm_chart_version: "{{ logging_chart_version }}"
    helm_value_file_template: "loki-values.yaml"
