---
- name: Gather switch facts
  switch_facts:

- name: Check mandatory variables for this role are set
  assert:
    fail_msg: "not all mandatory variables given, check role documentation"
    quiet: yes
    that:
      - sonic_mgmt_vrf is defined
      - sonic_loopback_address is defined
      - sonic_asn is defined
      - sonic_config_action in ['load', 'reload']
      - sonic_ntpservers is defined
      - sonic_nameservers is defined
      - metal_stack_switch_os_is_sonic

- name: render resolv.conf
  template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf

- name: Activate IP MASQUERADE on eth0
  ansible.builtin.iptables:
    chain: POSTROUTING
    jump: MASQUERADE
    out_interface: eth0
    table: nat
  when: sonic_ip_masquerade

- name: Activate ipv4 forwarding on eth0
  ansible.posix.sysctl:
    name: net.ipv4.conf.eth0.forwarding
    reload: no
    sysctl_set: yes
    value: "1"
  when: sonic_ip_masquerade

- name: Install services
  copy:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
  notify: reload systemd
  loop:
    - bgp-validation@.service
    - frr-reload.service

# Dependencies are returned by config.
- name: Configure breakouts
  command: "config interface breakout --yes {{ item.key }} '{{ item.value }}'"
  register: breakout_result
  changed_when: "'Breakout process got successfully completed.' in breakout_result.stdout"
  failed_when: "breakout_result.rc != 0 or 'Dependecies Exist. No further action will be taken' in breakout_result.stdout"
  with_dict: "{{ sonic_breakouts }}"
  when: sonic_breakouts is defined

- name: Get running configuration
  ansible.builtin.command: show runningconfiguration all
  register: sonic_running_cfg

- name: Extract running configuration for breakouts and ports
  ansible.builtin.set_fact:
    sonic_running_cfg_breakouts: "{{ sonic_running_cfg | community.general.json_query('BREAKOUT_CFG') }}"
    sonic_running_cfg_hwsku: "{{ sonic_running_cfg | community.general.json_query('DEVICE_METADATA.localhost.hwsku') }}"
    sonic_running_cfg_mac: "{{ sonic_running_cfg | community.general.json_query('DEVICE_METADATA.localhost.mac') }}"
    sonic_running_cfg_platform: "{{ sonic_running_cfg | community.general.json_query('DEVICE_METADATA.localhost.platform') }}"
    sonic_running_cfg_ports: "{{ sonic_running_cfg | community.general.json_query('PORT')  }}"

- name: Fail if running configuration doesn't contain required informations
  ansible.builtin.assert:
    that:
      - sonic_running_cfg_breakouts is defined and sonic_running_cfg_breakouts | length > 0
      - sonic_running_cfg_hwsku is defined and sonic_running_cfg_hwsku | length > 0
      - sonic_running_cfg_mac is defined and sonic_running_cfg_mac | length > 0
      - sonic_running_cfg_platform is defined and sonic_running_cfg_platform | length > 0
      - sonic_running_cfg_ports is defined and sonic_running_cfg_ports | length > 0
    fail_msg: The running configuration is incomplete because it does not contain 'BREAKOUT_CFG', 'PORT', or complete 'DEVICE_METADATA'.

- name: Fail if running configuration doesn't contain 'PORT'
  ansible.builtin.fail:
    msg: The running configuration doesn't contain 'PORT' {{ sonic_running_cfg }}
  when: "sonic_running_cfg_ports | length == 0"

- name: Render config_db
  set_fact:
    config_db: "{{ lookup('template', 'metal.yaml.j2') }}"

- name: Save config_db as JSON file
  copy:
    content: "{{ config_db | from_yaml | to_nice_json }}"
    dest: /etc/sonic/config_db.json
  notify: "config {{ sonic_config_action }}"

- name: Set NTP timezone
  timezone:
    name: "{{ sonic_timezone }}"

- name: Render frr config
  template:
    src: frr.conf.j2
    dest: /etc/sonic/frr/frr.conf
  when: sonic_frr_render
  notify:
  - restart bgp

- name: render iptables.json
  template:
    src: iptables.json.j2
    dest: /etc/sonic/iptables.json
  when: sonic_extended_cacl is defined
  notify:
  - restart caclmgrd

- name: Flush handlers
  meta: flush_handlers
