---
# # TODO check for a ansible module
# - name: enable management vrf for eth0
#   # sudo config vrf add mgmt 
#   # or put that to config_db.json
#   # "MGMT_VRF_CONFIG": {                                                                                                                                                  │2022/12/05 13:34:56 [notice] 1#1: signal 28 (SIGWINCH) received
#   #      "vrf_global": {                                                                                                                                                   │2022/12/05 13:34:56 [notice] 31#31: signal 28 (SIGWINCH) received
#   #          "mgmtVrfEnabled": "true"                                                                                                                                      │2022/12/05 13:34:56 [notice] 29#29: signal 28 (SIGWINCH) received
#   #      }                                                                                                                                                                 │2022/12/05 13:34:56 [notice] 1#1: signal 28 (SIGWINCH) received
#   #  },

# - name: enable route leak via mgmt vrf
#   # vtysh config 
#   # ip route 0.0.0.0/0 {{ ip of mgmt eth0 gateway }} nexthop-vrf mgmt

# - name: enable dns
#   # will be served and configured by dhcp server

# - name: enable ntp


- name: Activate IP MASQUERADE on eth0
  ansible.builtin.iptables:
    chain: POSTROUTING
    jump: MASQUERADE
    out_interface: eth0
    table: nat
  become: true

- name: Activate ipv4 forwarding on eth0
  ansible.posix.sysctl:
    name: net.ipv4.conf.eth0.forwarding
    reload: no
    sysctl_set: yes
    value: 1
  become: true

- name: Set hostname
  ansible.builtin.command: config hostname {{ metal_partition_id }}-{{ inventory_hostname }}
  become: true

- name: install services
  copy:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
  notify: reload systemd
  with_items:
    - bgp-validation@.service
    - write-to-db@.service
  become: true
