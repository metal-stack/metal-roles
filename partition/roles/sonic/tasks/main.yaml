---
- name: Check mandatory variables for this role are set
  assert:
    fail_msg: "not all mandatory variables given, check role documentation"
    quiet: yes
    that:
      - sonic_mgmt_vrf is defined
      - sonic_loopback_address is defined
      - sonic_asn is defined
      - sonic_ntpservers is defined
      - sonic_nameservers is defined

- name: render resolv.conf
  template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf

- name: Activate IP MASQUERADE on eth0
  ansible.builtin.iptables:
    chain: POSTROUTING
    jump: MASQUERADE
    out_interface: eth0
    table: nat
  when: sonic_ip_masquerade

- name: Activate ipv4 forwarding on eth0
  ansible.posix.sysctl:
    name: net.ipv4.conf.eth0.forwarding
    reload: no
    sysctl_set: yes
    value: "1"
  when: sonic_ip_masquerade

- name: Install frr reload helper
  copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: 755
  with_items:
    - frr-reload.py

- name: Install services
  copy:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
  notify: reload systemd
  with_items:
    - bgp-validation@.service
    - frr-reload.service

- name: Configure breakouts
  command: "config interface breakout -y {{ item.key }} '{{ item.value }}'"
  with_dict: "{{ sonic_breakouts }}"
  when: sonic_breakouts is defined

- name: Render metal config for config_db.json
  template:
    src: metal.yaml.j2
    dest: /etc/sonic/metal.yaml
  notify:
  - write metal conf to db
  - config reload
    
- name: Set NTP timezone
  timezone:
    name: "{{ sonic_timezone }}"

- name: Render frr config
  template:
    src: frr.conf.j2
    dest: /etc/sonic/frr/frr.conf
  when: sonic_frr_render
  notify:
  - restart bgp

- name: Flush handlers
  meta: flush_handlers
