---
- name: Create temporary directory
  file:
    path: /tmp/sonic
    state: directory

- name: Render input values template
  template:
    src: sonic-config.yaml.j2
    dest: /tmp/sonic/sonic-config.yaml

- name: Copy current config_db.json into temporary directory
  copy:
    src: /etc/sonic/config_db.json
    dest: /tmp/sonic/config_db.json
    mode: 0644
    remote_src: true

- name: Run sonic-configdb-utils
  community.docker.docker_container:
    name: sonic-configdb-utils
    image: "{{ sonic_configdb_utils_image_name }}:{{ sonic_configdb_utils_image_tag }}"
    pull: true
    detach: false
    cleanup: true
    command: generate
    volumes:
      - /usr/share/sonic/device:/usr/share/sonic/device:ro
      - /tmp/sonic:/etc/sonic:rw
      - /tmp/sonic:/sonic:ro

- name: Override the existing config_db.json with the newly generated one
  copy:
    src: /tmp/sonic/config_db.json
    dest: /etc/sonic/config_db.json
    mode: 0644
    owner: root
    group: root
    remote_src: true

- name: Flush handlers
  meta: flush_handlers

- name: Register lldp timer
  shell: lldpcli show configuration | grep "Transmit delay:"
  register: hello_timer

- name: Restart lldp service to ensure hello timer gets applied
  service:
    name: lldp
    state: restarted
  when: hello_timer['Transmit delay'] != {{ sonic_lldp_hello_timer }}

- name: Remove temporary directory
  file:
    path: /tmp/sonic/
    state: absent
